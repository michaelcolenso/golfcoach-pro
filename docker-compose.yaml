version: '3.8'

 

services:

  # PostgreSQL with TimescaleDB

  postgres:

    image: timescale/timescaledb:latest-pg15

    container_name: golfcoach-postgres

    environment:

      POSTGRES_DB: golfcoach

      POSTGRES_USER: golfcoach_user

      POSTGRES_PASSWORD: golfcoach_pass

      PGDATA: /var/lib/postgresql/data/pgdata

    ports:

      - "5432:5432"

    volumes:

      - postgres_data:/var/lib/postgresql/data

      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql

    healthcheck:

      test: ["CMD-SHELL", "pg_isready -U golfcoach_user -d golfcoach"]

      interval: 10s

      timeout: 5s

      retries: 5

    networks:

      - golfcoach-network

 

  # Redis

  redis:

    image: redis:7-alpine

    container_name: golfcoach-redis

    ports:

      - "6379:6379"

    volumes:

      - redis_data:/data

    healthcheck:

      test: ["CMD", "redis-cli", "ping"]

      interval: 10s

      timeout: 5s

      retries: 5

    networks:

      - golfcoach-network

 

  # MinIO (S3-compatible storage)

  minio:

    image: minio/minio:latest

    container_name: golfcoach-minio

    command: server /data --console-address ":9001"

    environment:

      MINIO_ROOT_USER: minioadmin

      MINIO_ROOT_PASSWORD: minioadmin

    ports:

      - "9000:9000"  # API

      - "9001:9001"  # Console

    volumes:

      - minio_data:/data

    healthcheck:

      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]

      interval: 30s

      timeout: 20s

      retries: 3

    networks:

      - golfcoach-network

 

  # MinIO bucket creation

  minio-init:

    image: minio/mc:latest

    container_name: golfcoach-minio-init

    depends_on:

      - minio

    entrypoint: >

      /bin/sh -c "

      sleep 5;

      mc alias set myminio http://minio:9000 minioadmin minioadmin;

      mc mb myminio/golfcoach-videos --ignore-existing;

      mc anonymous set download myminio/golfcoach-videos;

      exit 0;

      "

    networks:

      - golfcoach-network

 

  # FastAPI Backend

  backend:

    build:

      context: ./backend

      dockerfile: Dockerfile

    container_name: golfcoach-backend

    environment:

      - DATABASE_URL=postgresql://golfcoach_user:golfcoach_pass@postgres:5432/golfcoach

      - REDIS_URL=redis://redis:6379/0

      - CELERY_BROKER_URL=redis://redis:6379/1

      - CELERY_RESULT_BACKEND=redis://redis:6379/2

      - MINIO_ENDPOINT=minio:9000

      - MINIO_ACCESS_KEY=minioadmin

      - MINIO_SECRET_KEY=minioadmin

      - MINIO_SECURE=false

      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      - DEBUG=true

      - RELOAD=true

    ports:

      - "8000:8000"

    volumes:

      - ./backend:/app

      - /tmp/golfcoach:/tmp/golfcoach

    depends_on:

      postgres:

        condition: service_healthy

      redis:

        condition: service_healthy

      minio:

        condition: service_healthy

    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

    networks:

      - golfcoach-network

 

  # Celery Worker

  celery-worker:

    build:

      context: ./backend

      dockerfile: Dockerfile

    container_name: golfcoach-celery-worker

    environment:

      - DATABASE_URL=postgresql://golfcoach_user:golfcoach_pass@postgres:5432/golfcoach

      - REDIS_URL=redis://redis:6379/0

      - CELERY_BROKER_URL=redis://redis:6379/1

      - CELERY_RESULT_BACKEND=redis://redis:6379/2

      - MINIO_ENDPOINT=minio:9000

      - MINIO_ACCESS_KEY=minioadmin

      - MINIO_SECRET_KEY=minioadmin

      - MINIO_SECURE=false

      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

    volumes:

      - ./backend:/app

      - /tmp/golfcoach:/tmp/golfcoach

    depends_on:

      - postgres

      - redis

      - minio

    command: celery -A app.tasks.celery_app worker --loglevel=info --concurrency=2

    networks:

      - golfcoach-network

 

  # Celery Beat (Scheduled tasks)

  celery-beat:

    build:

      context: ./backend

      dockerfile: Dockerfile

    container_name: golfcoach-celery-beat

    environment:

      - DATABASE_URL=postgresql://golfcoach_user:golfcoach_pass@postgres:5432/golfcoach

      - REDIS_URL=redis://redis:6379/0

      - CELERY_BROKER_URL=redis://redis:6379/1

      - CELERY_RESULT_BACKEND=redis://redis:6379/2

    volumes:

      - ./backend:/app

    depends_on:

      - postgres

      - redis

    command: celery -A app.tasks.celery_app beat --loglevel=info

    networks:

      - golfcoach-network

 

  # Flower (Celery monitoring)

  flower:

    build:

      context: ./backend

      dockerfile: Dockerfile

    container_name: golfcoach-flower

    environment:

      - CELERY_BROKER_URL=redis://redis:6379/1

      - CELERY_RESULT_BACKEND=redis://redis:6379/2

    ports:

      - "5555:5555"

    depends_on:

      - redis

      - celery-worker

    command: celery -A app.tasks.celery_app flower --port=5555

    networks:

      - golfcoach-network

 

  # Prometheus (Metrics)

  prometheus:

    image: prom/prometheus:latest

    container_name: golfcoach-prometheus

    ports:

      - "9090:9090"

    volumes:

      - ./infrastructure/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

      - prometheus_data:/prometheus

    command:

      - '--config.file=/etc/prometheus/prometheus.yml'

      - '--storage.tsdb.path=/prometheus'

    networks:

      - golfcoach-network

 

  # Grafana (Dashboards)

  grafana:

    image: grafana/grafana:latest

    container_name: golfcoach-grafana

    ports:

      - "3001:3000"

    environment:

      - GF_SECURITY_ADMIN_USER=admin

      - GF_SECURITY_ADMIN_PASSWORD=admin

      - GF_INSTALL_PLUGINS=redis-datasource

    volumes:

      - grafana_data:/var/lib/grafana

      - ./infrastructure/grafana/dashboards:/etc/grafana/provisioning/dashboards

      - ./infrastructure/grafana/datasources:/etc/grafana/provisioning/datasources

    depends_on:

      - prometheus

    networks:

      - golfcoach-network

 

  # pgAdmin (Database management)

  pgadmin:

    image: dpage/pgadmin4:latest

    container_name: golfcoach-pgadmin

    environment:

      PGADMIN_DEFAULT_EMAIL: admin@golfcoach.local

      PGADMIN_DEFAULT_PASSWORD: admin

    ports:

      - "5050:80"

    depends_on:

      - postgres

    networks:

      - golfcoach-network

 

volumes:

  postgres_data:

  redis_data:

  minio_data:

  prometheus_data:

  grafana_data:

 

networks:

  golfcoach-network:

    driver: bridge
